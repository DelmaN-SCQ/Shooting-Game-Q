<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shooting Game Q Pro</title>
<style>
  :root{
    --bg1:#071018; --bg2:#0b0d10; --accent:#0fd3ff;
    --panel:#0f1720; --muted:#94a3b8;
    --accent2:#8be04a; --danger:#ff6b6b;
  }
  body{margin:0; height:100vh; background:linear-gradient(180deg,var(--bg1),var(--bg2)); font-family:Inter, Arial, sans-serif; color:#e6eef6; overflow:hidden;}
  canvas{display:block;}
  /* Center menus */
  .center {
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    text-align:center;
  }
  #menu, #pauseMenu, #gameover, #settingsPanel {
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12));
    border:1px solid rgba(255,255,255,0.06);
    padding:24px; border-radius:12px; box-shadow: 0 8px 30px rgba(2,6,23,0.6);
  }
  h1{margin:10px 0 6px; font-size:40px; letter-spacing:1px; color:var(--accent); text-shadow:0 4px 18px rgba(15,211,255,0.12);}
  p.hint{color:var(--muted); margin:6px 0 14px;}
  .btn{display:inline-block; padding:12px 22px; margin:8px; border-radius:10px; border:0; cursor:pointer; font-size:16px; color:#061018; background:linear-gradient(90deg,#9ef6ff,#7ad1ff); box-shadow:0 6px 18px rgba(10,130,160,0.12);}
  .btn.secondary{background:linear-gradient(90deg,#cbd5e1,#94a3b8); color:#021018;}
  .small{padding:8px 12px; font-size:14px; border-radius:8px;}
  #topRight {
    position: absolute; right:18px; top:10px; display:flex; gap:12px; align-items:center;
  }
  .statBox {
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
    padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04);
    min-width:140px; text-align:left; color:#dff6ff; box-shadow: 0 6px 30px rgba(2,6,23,0.45);
  }
  .statTitle{font-size:12px; color:var(--muted);}
  .statValue{font-size:18px; font-weight:700; margin-top:4px;}
  #settingsPanel{display:none; width:360px;}
  label{display:block; margin:8px 0 4px; font-size:13px; color:var(--muted);}
  select,input[type=checkbox]{width:100%; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:inherit;}
  #footerHint{position:absolute; left:18px; bottom:10px; color:var(--muted); font-size:13px;}
  /* Pause overlay */
  #pauseOverlay{position:absolute;left:0;top:0;right:0;bottom:0;background:rgba(2,6,23,0.45); display:flex; align-items:center; justify-content:center; z-index:50; display:none;}
  #pauseBox{padding:18px 28px; border-radius:12px; background:linear-gradient(180deg,#071018,#0b1220); border:1px solid rgba(255,255,255,0.04); text-align:center;}
  #themePreview{width:36px;height:18px;border-radius:3px; display:inline-block; margin-left:8px; border:1px solid rgba(255,255,255,0.06);}
  /* small responsive */
  @media (max-width:600px){
    h1{font-size:28px;} .statBox{min-width:110px; font-size:13px;}
  }
</style>
</head>
<body>
  <div id="topRight">
    <div class="statBox"><div class="statTitle">Punkty</div><div id="uiScore" class="statValue">0</div></div>
    <div class="statBox"><div class="statTitle">Poziom</div><div id="uiLevel" class="statValue">1</div></div>
    <div class="statBox"><div class="statTitle">High Score</div><div id="uiHigh" class="statValue">0</div></div>
    <button id="openSettings" class="btn small secondary">Ustawienia</button>
  </div>

  <div id="menu" class="center">
    <h1>Shooting Game Q Pro</h1>
    <p class="hint">Motyw: <strong id="currentThemeName">Dark Metal</strong> · Pauza: <kbd>P</kbd></p>
    <div>
      <button id="startBtn" class="btn">Zagraj</button>
      <button id="startHard" class="btn small secondary">Tryb: Hard</button>
    </div>
    <p class="hint">Wybierz trudność w ustawieniach. Możesz wcisnąć <strong>P</strong> żeby zapauzować.</p>
  </div>

  <div id="settingsPanel" class="center" style="left:unset; right:18px; top:120px;">
    <h3 style="margin:0 0 10px;color:var(--accent);">Ustawienia</h3>
    <label>Motyw</label>
    <select id="themeSelect">
      <option value="darkmetal">Dark Metal</option>
      <option value="space">Space Blue</option>
      <option value="orchid">Neon Orchid</option>
      <option value="classic">Classic Retro</option>
    </select>
    <label>Trudność</label>
    <select id="difficulty">
      <option value="easy">Easy</option>
      <option value="normal" selected>Normal</option>
      <option value="hard">Hard</option>
    </select>
    <label><input type="checkbox" id="muteToggle"> Wycisz dźwięki (Mute)</label>
    <div style="display:flex; gap:8px; margin-top:10px;">
      <button id="closeSettings" class="btn small secondary">Zamknij</button>
      <button id="resetProgress" class="btn small">Resetuj poziom/XP</button>
    </div>
  </div>

  <div id="pauseOverlay"><div id="pauseBox">
    <h2 style="margin:6px 0;color:var(--accent);">PAUZA</h2>
    <p style="color:var(--muted); margin:6px 0 12px;">Wciśnij <kbd>P</kbd> aby wznowić</p>
    <div>
      <button id="resumeBtn" class="btn">Wznów</button>
      <button id="pauseSettings" class="btn small secondary">Ustawienia</button>
    </div>
  </div></div>

  <div id="gameover" class="center" style="display:none;">
    <h1>Przegrałeś!</h1>
    <p class="hint">Poziom i XP zostały zapisane.</p>
    <button id="restartBtn2" class="btn">Restart</button>
    <button id="backToMenu" class="btn small secondary">Menu</button>
  </div>

  <canvas id="gameCanvas"></canvas>
  <div id="footerHint">Tip: Pauza = <strong>P</strong> · Mute dostępny w ustawieniach</div>

<script>
/* -------------------------
   Shooting Game Q Pro (single file)
   - Sprite PNGs generated in-code (offscreen canvas)
   - Themes, difficulties, pause, improved sounds, level-up sound
   - Explosions, improved rocket/pellet sizes, settings panel
   - Persistent: level, xp, xpGoal, highScore (localStorage)
   - Useful thing chosen: MUTE toggle + difficulty quick-start
   ------------------------- */

/* Canvas setup */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize);
resize();

/* UI refs */
const uiScore = document.getElementById('uiScore');
const uiLevel = document.getElementById('uiLevel');
const uiHigh = document.getElementById('uiHigh');
const menu = document.getElementById('menu');
const startBtn = document.getElementById('startBtn');
const startHardBtn = document.getElementById('startHard');
const settingsPanel = document.getElementById('settingsPanel');
const openSettingsBtn = document.getElementById('openSettings');
const closeSettingsBtn = document.getElementById('closeSettings');
const themeSelect = document.getElementById('themeSelect');
const difficultySelect = document.getElementById('difficulty');
const muteToggle = document.getElementById('muteToggle');
const resetProgress = document.getElementById('resetProgress');
const pauseOverlay = document.getElementById('pauseOverlay');
const restartBtn = document.getElementById('restartBtn2');
const backToMenu = document.getElementById('backToMenu');
const resumeBtn = document.getElementById('resumeBtn');
const pauseSettingsBtn = document.getElementById('pauseSettings');
const currentThemeName = document.getElementById('currentThemeName');

/* Persistent state */
let level = parseInt(localStorage.getItem('sgq_level')) || 1;
let xp = parseInt(localStorage.getItem('sgq_xp')) || 0;
let xpGoal = parseInt(localStorage.getItem('sgq_xpGoal')) || 100;
let highScore = parseInt(localStorage.getItem('sgq_high')) || 0;

/* Game state */
let gameStarted = false, gameOver = false, paused = false;
let score = 0, kills = 0;
let player = null;
let bullets = [], enemies = [], powerUps = [], explosions = [];

/* Settings */
let theme = localStorage.getItem('sgq_theme') || 'darkmetal';
let difficulty = localStorage.getItem('sgq_diff') || 'normal';
let isMuted = (localStorage.getItem('sgq_mute') === '1');

/* Difficulty params */
const difficultyPresets = {
  easy:   { enemyMax:6, enemyHP:30, enemySpeed:1.2, spawnRate:1400 },
  normal: { enemyMax:8, enemyHP:40, enemySpeed:1.8, spawnRate:1100 },
  hard:   { enemyMax:12,enemyHP:60, enemySpeed:2.4, spawnRate:800  }
};
let diff = difficultyPresets[difficulty];

/* Theme presets */
const themes = {
  darkmetal: {bg1:'#071018', bg2:'#0b0d10', accent:'#7ad1ff', panel:'#0f1720'},
  space:     {bg1:'#041426', bg2:'#001021', accent:'#6ff', panel:'#06121a'},
  orchid:    {bg1:'#120517', bg2:'#200a1a', accent:'#ff7ad1', panel:'#1a0712'},
  classic:   {bg1:'#001018', bg2:'#001820', accent:'#39ff14', panel:'#071014'}
};

/* Audio (small wrappers) */
const audio = {
  shoot: new Audio('https://freesound.org/data/previews/66/66717_931655-lq.mp3'),
  hit:   new Audio('https://freesound.org/data/previews/256/256113_4486188-lq.mp3'),
  pickup:new Audio('https://freesound.org/data/previews/331/331912_3248244-lq.mp3'),
  damage:new Audio('https://freesound.org/data/previews/331/331912_3248244-lq.mp3'),
  level: new Audio('https://freesound.org/data/previews/331/331903_3248244-lq.mp3') // different small tone
};
function playSound(s){
  if(isMuted) return;
  if(s && s.currentTime!==undefined){ try{ s.currentTime = 0; s.play(); }catch(e){} }
}

/* Generate small pixel sprites in-code (offscreen canvases) */
function makeSprite(pixels, scale, colors){
  const w = pixels[0].length, h = pixels.length;
  const oc = document.createElement('canvas'); oc.width = w*scale; oc.height = h*scale;
  const octx = oc.getContext('2d');
  octx.imageSmoothingEnabled = false;
  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const v = pixels[y][x];
      if(v===0) continue;
      octx.fillStyle = colors[v] || '#000';
      octx.fillRect(x*scale, y*scale, scale, scale);
    }
  }
  const img = new Image();
  img.src = oc.toDataURL('image/png');
  return img;
}

/* rocket 16x16 pixel art, will be scaled */
const rocketMap = [
  [0,0,0,0,2,2,2,0,0,0,0,0,0,0,0,0],
  [0,0,0,2,3,3,3,2,0,0,0,0,0,0,0,0],
  [0,0,2,3,4,4,4,3,2,0,0,0,0,0,0,0],
  [0,2,3,4,4,4,4,4,3,2,0,0,0,0,0,0],
  [0,2,3,4,4,4,4,4,3,2,0,0,0,0,0,0],
  [0,2,3,4,4,5,4,4,3,2,0,0,0,0,0,0],
  [0,0,2,3,3,3,3,3,2,0,0,0,0,0,0,0],
  [0,0,0,2,2,2,2,2,0,0,0,0,0,0,0,0],
  [0,0,0,0,6,6,6,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,6,6,6,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,6,6,6,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,6,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,6,6,6,0,0,0,0,0,0,0,0,0],
  [0,0,0,6,6,6,6,6,0,0,0,0,0,0,0,0],
  [0,0,0,2,2,0,2,2,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
];
const rocketColors = {2:'#0fd3ff',3:'#6fffff',4:'#7fffbf',5:'#ffb34d',6:'#ff6b6b'};
const rocketSprite = makeSprite(rocketMap,2,rocketColors); // scale2 -> 32x32 approx

/* bullet sprite */
const bulletMap = [
  [0,2,0],
  [2,2,2],
  [0,2,0]
];
const bulletSprite = makeSprite(bulletMap,3,{2:'#ffea4d'}); // 3 => 9x9 (we will scale on draw)

/* hp powerup (green dot) */
const hpMap = [
  [0,0,2,2,0,0],
  [0,2,2,2,2,0],
  [2,2,2,2,2,2],
  [2,2,2,2,2,2],
  [0,2,2,2,2,0],
  [0,0,2,2,0,0]
];
const hpSprite = makeSprite(hpMap,3,{2:'#7ef05a'});

/* shield powerup (blue) */
const shieldMap = [
  [0,3,3,3,0],
  [3,3,3,3,3],
  [3,3,3,3,3],
  [3,3,3,3,3],
  [0,3,3,3,0]
];
const shieldSprite = makeSprite(shieldMap,4,{3:'#5ad5ff'});

/* Explosion frames generator (simple circles) */
function spawnExplosion(x,y, color='#ffcc66'){
  const e = {x,y,t:0,ttl:30,color};
  explosions.push(e);
}

/* Helper: clamp */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

/* Start/reset logic */
function resetGame(resetPersistent=false){
  player = {
    x: canvas.width/2,
    y: canvas.height-90,
    width: 40,  // increased size rocket
    height: 48,
    speed: 7,
    lives: 100,
    maxLives: 100,
    shield: false
  };
  bullets = [];
  enemies = [];
  powerUps = [];
  explosions = [];
  score = 0;
  kills = 0;
  shieldTimer = 0;
  if(resetPersistent){
    level = 1; xp = 0; xpGoal = 100; localSave();
  }
  updateUI();
}

/* Because we used let earlier for player/bullets, re-declare properly: */
let shieldTimer = 0;
resetGame(false);

/* Save persistent to localStorage */
function localSave(){
  localStorage.setItem('sgq_level', level);
  localStorage.setItem('sgq_xp', xp);
  localStorage.setItem('sgq_xpGoal', xpGoal);
  localStorage.setItem('sgq_high', highScore);
  localStorage.setItem('sgq_theme', theme);
  localStorage.setItem('sgq_diff', difficulty);
  localStorage.setItem('sgq_mute', isMuted ? '1' : '0');
}

/* UI update */
function updateUI(){
  uiScore.innerText = score;
  uiLevel.innerText = level;
  uiHigh.innerText = highScore;
  document.getElementById('currentThemeName').innerText = {
    darkmetal:'Dark Metal', space:'Space Blue', orchid:'Neon Orchid', classic:'Classic Retro'
  }[theme] || theme;
}

/* Spawning */
let lastEnemySpawn = 0;
let lastPowerSpawn = 0;
function spawnEnemy(){
  if(enemies.length >= diff.enemyMax) return;
  const size = 36;
  const x = Math.random()*(canvas.width - size);
  const hp = diff.enemyHP;
  const color = ['#f05a7a','#ff9f43','#a78bfa','#38bdf8'][Math.floor(Math.random()*4)];
  enemies.push({x,y:-size,width:size,height:size,hp,maxHp:hp,color,hitFlash:0});
}

/* Simple update loop with time delta for spawn control */
let lastTime = performance.now();
function gameLoop(t){
  const dt = t - lastTime;
  lastTime = t;

  if(!gameStarted){
    drawBackground();
    requestAnimationFrame(gameLoop);
    return;
  }

  if(!paused && !gameOver){
    // spawn according to preset rate
    lastEnemySpawn += dt;
    if(lastEnemySpawn > diff.spawnRate){ spawnEnemy(); lastEnemySpawn = 0; }
    lastPowerSpawn += dt;
    if(lastPowerSpawn > 15000){ spawnPowerUp(); lastPowerSpawn = 0; }
    update(dt);
  }
  draw();
  requestAnimationFrame(gameLoop);
}
requestAnimationFrame(gameLoop);

/* Controls */
const pressed = {};
document.addEventListener('keydown', (e)=>{
  pressed[e.key] = true;
  if(!gameStarted && e.key === ' '){
    startGame();
  }
  if(e.key === 'p' || e.key === 'P'){
    togglePause();
  }
  if(e.key === 'm' || e.key === 'M'){
    isMuted = !isMuted; localSave();
  }
});
document.addEventListener('keyup', (e)=>{ pressed[e.key] = false; });

/* Start functions (UI hookups) */
startBtn.onclick = ()=>{ difficulty = difficultySelect.value; applyDifficulty(); startGame(); };
startHardBtn.onclick = ()=>{ difficulty = 'hard'; difficultySelect.value = 'hard'; applyDifficulty(); startGame(); };
openSettingsBtn.onclick = ()=>{ settingsPanel.style.display = 'block'; };
closeSettingsBtn.onclick = ()=>{ settingsPanel.style.display = 'none'; };
pauseSettingsBtn.onclick = ()=>{ settingsPanel.style.display = 'block'; pauseOverlay.style.display='none'; paused=false; };
resumeBtn.onclick = ()=>{ togglePause(); };
restartBtn.onclick = ()=>{ gameOver=false; startGame(false); document.getElementById('gameover').style.display='none'; };
backToMenu.onclick = ()=>{ gameOver=false; gameStarted=false; menu.style.display='block'; document.getElementById('gameover').style.display='none'; };
resetProgress.onclick = ()=>{ if(confirm('Resetować poziom i XP?')){ level=1; xp=0; xpGoal=100; localSave(); updateUI(); } };

themeSelect.value = theme;
difficultySelect.value = difficulty;
muteToggle.checked = isMuted;
openSettingsBtn.onclick = ()=>{ settingsPanel.style.display = settingsPanel.style.display === 'block' ? 'none' : 'block'; };

/* apply difficulty and theme */
function applyDifficulty(){
  difficulty = difficultySelect.value;
  diff = difficultyPresets[difficulty];
  localSave();
}
difficultySelect.onchange = ()=>{ applyDifficulty(); };
themeSelect.onchange = ()=>{
  theme = themeSelect.value;
  Object.assign(document.documentElement.style, {});
  localSave();
  updateTheme();
};
muteToggle.onchange = ()=>{ isMuted = muteToggle.checked; localSave(); };

/* Start actual game */
function startGame(resetPersistent=true){
  menu.style.display = 'none';
  settingsPanel.style.display = 'none';
  paused = false;
  gameStarted = true;
  gameOver = false;
  // reset but keep persistent if false
  resetGame(!resetPersistent);
  applyDifficulty();
  updateUI();
}

/* Toggle Pause - improved overlay + blur effect */
function togglePause(){
  if(!gameStarted || gameOver) return;
  paused = !paused;
  pauseOverlay.style.display = paused ? 'flex' : 'none';
  // subtle canvas dim by drawing overlay in draw()
}

/* Update logic (dt in ms) */
function update(dt){
  // player move
  if(pressed['ArrowLeft'] || pressed['a']) player.x -= player.speed;
  if(pressed['ArrowRight'] || pressed['d']) player.x += player.speed;
  if(pressed['ArrowUp'] || pressed['w']) player.y -= player.speed;
  if(pressed['ArrowDown'] || pressed['s']) player.y += player.speed;
  player.x = clamp(player.x, player.width/2, canvas.width - player.width/2);
  player.y = clamp(player.y, player.height/2, canvas.height - player.height/2);

  // bullets
  for(let i=bullets.length-1;i>=0;i--){
    bullets[i].y -= 600 * (dt/1000); // speed independent of fps
    if(bullets[i].y < -50) bullets.splice(i,1);
  }

  // enemies
  for(let i=enemies.length-1;i>=0;i--){
    const e = enemies[i];
    e.y += diff.enemySpeed * (dt/16); // scale movement
    if(e.y > canvas.height + 50){ enemies.splice(i,1); continue; }
    // coll bullets
    for(let j=bullets.length-1;j>=0;j--){
      const b = bullets[j];
      if(rectIntersect(b, e)){
        bullets.splice(j,1);
        e.hp -= 20;
        e.hitFlash = 8;
        playSound(audio.hit);
        spawnExplosion(e.x + e.width/2, e.y + e.height/2, '#ffcc66');
        if(e.hp <= 0){
          score += 100;
          kills++;
          xp += 20;
          if(score >= 1000) xp += 30;
          if(score > highScore){ highScore = score; localSave(); }
          enemies.splice(i,1);
          playSound(audio.level); // little reward tone for kill (keeps it snappy)
        }
        break;
      }
    }
    if(rectIntersect(e, player) && !player.shield){
      // collide
      enemies.splice(i,1);
      player.lives -= 20;
      playSound(audio.damage);
      spawnExplosion(player.x, player.y, '#ff6b6b');
      if(player.lives <= 0){
        gameOver = true; gameStarted = false;
        document.getElementById('gameover').style.display = 'block';
      }
    }
  }

  // powerups
  for(let i=powerUps.length-1;i>=0;i--){
    const p = powerUps[i];
    p.y += 1.6 * (dt/16);
    p.pulse += 0.06 * (dt/16);
    if(rectIntersect({x:player.x-player.width/2,y:player.y-player.height/2,width:player.width,height:player.height}, {x:p.x,y:p.y,width:p.size,height:p.size})){
      if(p.type === 'life'){ player.lives = Math.min(player.lives + 20, player.maxLives); }
      else if(p.type === 'shield'){ player.shield = true; shieldTimer = 600; }
      playSound(audio.pickup);
      powerUps.splice(i,1);
    }
    if(p.y > canvas.height + 30) powerUps.splice(i,1);
  }

  // shield timer
  if(player.shield){
    shieldTimer -= (dt/16);
    if(shieldTimer <= 0){ player.shield = false; shieldTimer = 0; }
  }

  // explosions animate
  for(let i=explosions.length-1;i>=0;i--){
    const ex = explosions[i];
    ex.t++;
    if(ex.t > ex.ttl) explosions.splice(i,1);
  }

  // level up
  if(xp >= xpGoal){
    level++;
    xp -= xpGoal;
    xpGoal = Math.floor(xpGoal * 1.5);
    playSound(audio.level); // level-up sound
  }

  // spawn caps
  if(enemies.length < diff.enemyMax){
    // spawn handled by interval timers outside update loop
  }

  updateUI();
  localSave();
}

/* Rect intersection helper */
function rectIntersect(a,b){
  return !(a.x + (a.width||0) < b.x || a.x > b.x + (b.width||b.size) ||
           a.y + (a.height||0) < b.y || a.y > b.y + (b.height||b.size));
}

/* Fire bullet helper (with sprite) */
function fireBullet(){
  const bW = Math.max(10, Math.floor(player.width / 3));
  const bH = Math.max(14, Math.floor(player.height / 3));
  bullets.push({x:player.x - bW/2, y:player.y - player.height/2 - 6, width: bW, height: bH, sprite: bulletSprite});
  playSound(audio.shoot);
}

/* spawn powerup */
function spawnPowerUp(){
  if(powerUps.length >= diff.enemyMax) return;
  const size = 20;
  const x = Math.random()*(canvas.width - size);
  const type = Math.random() < 0.5 ? 'life' : 'shield';
  powerUps.push({x, y: -size, size, type, pulse: Math.random()*Math.PI*2});
}

/* draw background & HUD & game objects */
function drawBackground(){
  const t = performance.now()/1000;
  // gradient background based on theme
  const th = themes[theme] || themes.darkmetal;
  document.body.style.background = `radial-gradient(circle at 20% 10%, ${th.bg1}, ${th.bg2})`;
  // subtle stars drawing
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // decorative lines
  for(let i=0;i<6;i++){
    ctx.strokeStyle = `rgba(255,255,255,${0.02 + i*0.01})`;
    ctx.lineWidth = 1;
    ctx.beginPath();
    const y = (i/6) * canvas.height + (t*10 % 30);
    ctx.moveTo(0,y); ctx.lineTo(canvas.width, y+ (Math.sin(t + i) * 20));
    ctx.stroke();
  }
}

/* draw everything */
function draw(){
  drawBackground();

  if(!gameStarted && !gameOver){
    // draw menu hint overlay slightly
    ctx.font = '18px Arial'; ctx.fillStyle = 'rgba(255,255,255,0.08)';
    ctx.textAlign = 'center';
    ctx.fillText('Motyw: ' + (currentThemeName.innerText || 'Dark Metal'), canvas.width/2, canvas.height/2 + 120);
    return;
  }

  // draw player (sprite scaled)
  ctx.save();
  // draw explosions under objects
  for(const ex of explosions) drawExplosion(ex);

  // bullets
  for(const b of bullets){
    if(b.sprite && b.sprite.complete){
      const scale = Math.max(1, Math.floor(b.width / b.sprite.width * 1.0));
      ctx.drawImage(b.sprite, b.x, b.y, b.width, b.height);
    } else {
      ctx.fillStyle = '#ffea4d'; ctx.fillRect(b.x,b.y,b.width,b.height);
    }
  }

  // enemies
  for(const e of enemies){
    // hit flash
    if(e.hitFlash && e.hitFlash > 0){
      ctx.fillStyle = '#ffffff';
      e.hitFlash--;
    } else ctx.fillStyle = e.color;
    ctx.fillRect(e.x, e.y, e.width, e.height);
    // enemy HP bar w górze
    ctx.fillStyle = '#222'; ctx.fillRect(e.x, e.y-6, e.width, 5);
    ctx.fillStyle = '#7ef05a'; ctx.fillRect(e.x, e.y-6, e.width * (e.hp / e.maxHp), 5);
    if(e.hitFlash && e.hitFlash > 0){
      // small flash effect
      ctx.fillStyle = 'rgba(255,255,255,0.12)'; ctx.fillRect(e.x, e.y, e.width, e.height);
    }
  }

  // player (use rocket sprite scaled)
  const rs = rocketSprite;
  const rW = player.width, rH = player.height;
  if(rs && rs.complete){
    ctx.drawImage(rs, player.x - rW/2, player.y - rH/2, rW, rH);
  } else {
    ctx.fillStyle = player.shield ? '#5ad5ff' : '#7ef05a';
    ctx.fillRect(player.x - player.width/2, player.y - player.height/2, player.width, player.height);
  }

  // powerups (animated)
  for(const p of powerUps){
    const sprite = p.type === 'life' ? hpSprite : shieldSprite;
    const pulse = 1 + Math.sin(p.pulse) * 0.12;
    const sW = p.size * pulse, sH = p.size * pulse;
    if(sprite && sprite.complete){
      ctx.drawImage(sprite, p.x - (sW - p.size)/2, p.y - (sH - p.size)/2, sW, sH);
    } else {
      ctx.fillStyle = p.type === 'life' ? '#7ef05a' : '#5ad5ff';
      ctx.fillRect(p.x,p.y,p.size,p.size);
    }
  }

  // draw explosions above
  for(const ex of explosions) drawExplosion(ex);

  ctx.restore();

  // HUD (bottom: HP & XP bars)
  const barW = 340;
  const pad = 24;

  // HP bar container
  const bx = pad, by = canvas.height - 70;
  ctx.fillStyle = 'rgba(255,255,255,0.03)';
  roundRect(ctx, bx-4, by-6, barW+8, 46, 8, true, false);
  // HP bar bg
  ctx.fillStyle = '#222';
  roundRect(ctx, bx, by, barW, 20, 6, true, false);
  // HP gradient
  const g = ctx.createLinearGradient(bx,by,bx+barW,by+20);
  g.addColorStop(0,'#ff6b6b'); g.addColorStop(0.5,'#ffd166'); g.addColorStop(1,'#7ef05a');
  ctx.fillStyle = g;
  roundRect(ctx, bx, by, (player.lives/player.maxLives)*barW, 20, 6, true, false);
  ctx.strokeStyle = 'rgba(255,255,255,0.06)';
  roundRect(ctx, bx, by, barW, 20, 6, false, true);

  // XP bar under HP
  const by2 = by + 26;
  ctx.fillStyle = '#222';
  roundRect(ctx, bx, by2, barW, 12, 6, true, false);
  ctx.fillStyle = '#4cc9f0';
  roundRect(ctx, bx, by2, (xp/xpGoal)*barW, 12, 6, true, false);
  ctx.strokeStyle = 'rgba(255,255,255,0.04)';
  roundRect(ctx, bx, by2, barW, 12, 6, false, true);

  // Text over HUD
  ctx.font = '14px Inter, Arial';
  ctx.fillStyle = '#cfeff6';
  ctx.textAlign = 'left';
  ctx.fillText('HP', bx, by - 8);
  ctx.fillText(`XP: ${xp}/${xpGoal}`, bx + barW - 110, by2 + 10);

  // top-right stats (draw nicer)
  ctx.textAlign = 'right';
  const trx = canvas.width - 20;
  ctx.font = '20px Inter, Arial';
  // gradient title
  const grad = ctx.createLinearGradient(trx-220,10, trx, 10);
  grad.addColorStop(0, themes[theme].accent || '#7ad1ff');
  grad.addColorStop(1, '#ff7ad1');
  ctx.fillStyle = grad;
  ctx.fillText(`Punkty: ${score}`, trx, 32);
  ctx.fillStyle = '#dbeafe';
  ctx.fillText(`Poziom: ${level}`, trx, 60);
  ctx.fillStyle = '#f0f7ff';
  ctx.fillText(`High: ${highScore}`, trx, 92);

  // Pause overlay if paused
  if(paused){
    ctx.fillStyle = 'rgba(2,6,23,0.45)';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.font = '56px Inter, Arial'; ctx.fillStyle = 'white'; ctx.textAlign = 'center';
    ctx.fillText('PAUZA', canvas.width/2, canvas.height/2);
  }
}

/* draw single explosion frame */
function drawExplosion(ex){
  const t = ex.t / ex.ttl;
  const r = t * 40 + 8;
  const alpha = 1 - t;
  ctx.beginPath();
  ctx.fillStyle = hexToRgba(ex.color, 0.9 * alpha);
  ctx.arc(ex.x, ex.y, r, 0, Math.PI*2);
  ctx.fill();
}

/* spawn helper for explosion usage elsewhere */
function createExplosionAt(x,y){
  const color = '#ffcc66';
  explosions.push({x,y,t:0,ttl:30,color});
}

/* rounded rect helper */
function roundRect(ctx,x,y,w,h,r,fill,stroke){
  if(typeof r === 'undefined') r = 5;
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);
  ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
  if(fill) ctx.fill();
  if(stroke) ctx.stroke();
}

/* small util */
function hexToRgba(hex,alpha=1){
  const c = hex.replace('#','');
  const r = parseInt(c.substring(0,2),16);
  const g = parseInt(c.substring(2,4),16);
  const b = parseInt(c.substring(4,6),16);
  return `rgba(${r},${g},${b},${alpha})`;
}

/* Fire control - space bar shoots, but also support mouse click */
document.addEventListener('keydown', (e)=>{
  if(e.key === ' '){ // prevent page scroll
    e.preventDefault();
    if(gameStarted && !paused && !gameOver) fireBullet();
  }
});
canvas.addEventListener('mousedown', (e) => {
  if(gameStarted && !paused && !gameOver) fireBullet();
});

/* fire bullet using sprite */
function fireBullet(){
  const bW = Math.max(12, Math.floor(player.width / 3));
  const bH = Math.max(18, Math.floor(player.height / 3));
  bullets.push({x:player.x - bW/2, y:player.y - player.height/2 - 6, width: bW, height: bH, sprite: bulletSprite});
  playSound(audio.shoot);
}

/* small interval spawners - use timers (not setInterval heavy loops) */
setInterval(()=>{ if(gameStarted && !paused && !gameOver){ if(enemies.length < diff.enemyMax) spawnEnemy(); } }, 500);
setInterval(()=>{ if(gameStarted && !paused && !gameOver){ if(powerUps.length < 2) spawnPowerUp(); } }, 4000);

/* Persist and UI sync on load */
function updateTheme(){
  const th = themes[theme] || themes.darkmetal;
  document.documentElement.style.setProperty('--bg1', th.bg1);
  document.documentElement.style.setProperty('--bg2', th.bg2);
  document.documentElement.style.setProperty('--accent', th.accent || '#7ad1ff');
  updateUI();
}
updateTheme();

/* helper: playSound wrapper that respects mute UI */
function playSound(sound){
  if(isMuted) return;
  try{ sound.currentTime=0; sound.play(); }catch(e){}
}

/* initial UI values */
updateUI();

/* helper to toggle pause from UI */
function togglePauseFromUI(){
  if(!gameStarted) return;
  togglePause();
}

/* small keyboard to UI map for quick difficulty toggle */
startHardBtn.addEventListener('click', ()=>{ difficultySelect.value='hard'; applyDifficulty(); startGame(); });

/* make sure UI controls close properly */
closeSettingsBtn.onclick = ()=>{ settingsPanel.style.display='none'; };

/* more buttons */
document.getElementById('restartBtn2').onclick = ()=>{
  resetGame(false);
  gameOver=false; gameStarted=true;
  document.getElementById('gameover').style.display='none';
};

/* ensure menu start uses selected difficulty & theme */
startBtn.onclick = ()=>{
  difficulty = difficultySelect.value;
  applyDifficulty();
  startGame(true);
};

/* bind pause overlay resume */
resumeBtn.onclick = ()=>{ togglePause(); };

/* utility to apply settings & save */
function applySettings(){
  theme = themeSelect.value;
  difficulty = difficultySelect.value;
  isMuted = muteToggle.checked;
  difficultySelect.value = difficulty;
  themeSelect.value = theme;
  muteToggle.checked = isMuted;
  applyDifficulty();
  updateTheme();
  localSave();
}
closeSettingsBtn.addEventListener('click', ()=>{ applySettings(); settingsPanel.style.display='none'; });

/* initial apply of difficulty/theme */
applyDifficulty();
updateTheme();

/* final fix: ensure rocket and bullets visible sizes (done above) */

/* END of main code */
</script>
</body>
</html>
