<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shooting Game Q Pro</title>
<style>
  :root{
    --bg1:#07101a;
    --bg2:#000;
    --accent:#0ff;
    --text:#e6eef5;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));font-family:Inter,Arial,sans-serif;color:var(--text);-webkit-font-smoothing:antialiased}
  canvas{display:block;width:100vw;height:100vh;}
  /* top-right HUD box styling */
  .hud {
    position: absolute; right: 18px; top: 12px;
    display: flex; flex-direction: column; gap:8px; align-items:flex-end;
  }
  .hud .pill {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.06);
    padding: 8px 14px; border-radius: 12px;
    backdrop-filter: blur(6px);
    min-width: 200px; text-align:right;
    box-shadow: 0 4px 18px rgba(0,0,0,0.5);
  }
  .hud .title{font-weight:700; font-size:18px; color:var(--accent); text-shadow:0 0 8px rgba(0,255,255,0.06);}
  .hud .small{font-size:13px; color:#cfe7ffcc;}
  /* bottom bars area is drawn on canvas, not DOM - but keep small label */
  /* menu center */
  #menu, #gameover, #pauseOverlay {
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    text-align:center; padding:30px; border-radius:12px;
    background: linear-gradient(180deg, rgba(0,0,0,0.55), rgba(10,10,10,0.6));
    border:1px solid rgba(255,255,255,0.06);
    box-shadow: 0 10px 40px rgba(0,0,0,0.6);
  }
  #menu h1, #gameover h1{margin:0 0 10px 0; font-size:40px; color:var(--accent); letter-spacing:1px;}
  #menu p{margin:6px 0 14px 0; color:#bfe9ff;}
  .btn {
    display:inline-block; padding:12px 24px; border-radius:10px; font-size:16px;
    cursor:pointer; border:1px solid rgba(255,255,255,0.08);
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    color:var(--text); margin:6px;
  }
  .btn.primary{background:linear-gradient(90deg,#1f8cff,#7df0ff); color:#001; font-weight:700;}
  /* settings top-left */
  #settingsBtn { position:absolute; left:12px; top:12px; padding:8px 10px; border-radius:8px; background:rgba(0,0,0,0.45); border:1px solid rgba(255,255,255,0.06); color:var(--text); cursor:pointer; }
  #settingsPanel {
    position:absolute; left:12px; top:52px; width:300px; padding:12px; border-radius:10px;
    background:linear-gradient(180deg, rgba(10,10,12,0.85), rgba(6,6,8,0.75));
    border:1px solid rgba(255,255,255,0.04); display:none;
  }
  #settingsPanel label{display:block;font-size:13px;margin-top:8px;color:#cfe7ff;}
  select,input[type=range]{width:100%; margin-top:6px; padding:6px; border-radius:6px; background:#0b1115; color:var(--text); border:1px solid rgba(255,255,255,0.06);}
  .row{display:flex;gap:8px}
  .row .btn{flex:1; text-align:center;}
  /* small footer note in menu */
  .muted{color:#9fbcd9; font-size:13px}
</style>
</head>
<body>

<!-- Settings button & panel (top-left) -->
<button id="settingsBtn" title="Ustawienia">âš™ Ustawienia</button>
<div id="settingsPanel">
  <label>Motyw</label>
  <select id="themeSelect">
    <option value="darkmetal">Dark Metal</option>
    <option value="cyberchrome">Cyber Chrome</option>
    <option value="blueneon">Blue Neon Sky</option>
  </select>

  <label>TrudnoÅ›Ä‡</label>
  <select id="difficultySelect">
    <option value="easy">Easy</option>
    <option value="normal" selected>Normal</option>
    <option value="hard">Hard</option>
  </select>

  <label>GÅ‚oÅ›noÅ›Ä‡</label>
  <input id="volume" type="range" min="0" max="1" step="0.01" value="0.8">

  <label>Opcje</label>
  <div class="row">
    <button class="btn" id="muteBtn">ðŸ”‡ Mute</button>
    <button class="btn" id="resetProgressBtn">Resetuj Poziom</button>
  </div>
</div>

<!-- HUD top-right -->
<div class="hud" id="hud">
  <div class="pill title" id="hudTitle">Shooting Game Q Pro</div>
  <div class="pill small" id="hudScore">Punkty: 0</div>
  <div class="pill small" id="hudLevel">Poziom: 1</div>
  <div class="pill small" id="hudHigh">High Score: 0</div>
</div>

<!-- menu / gameover / pause -->
<div id="menu">
  <h1>Shooting Game Q Pro</h1>
  <p>Zagraj â€” pauza: wciÅ›nij <strong>P</strong></p>
  <div>
    <button class="btn primary" id="startBtn">Zagraj</button>
    <button class="btn" id="startBtn2">Zagraj (ok)</button>
  </div>
  <p class="muted">Wybierz motyw i trudnoÅ›Ä‡ w ustawieniach (lewy gÃ³rny rÃ³g)</p>
</div>

<div id="gameover" style="display:none;">
  <h1>PrzegraÅ‚eÅ›!</h1>
  <div>
    <button class="btn primary" id="restartBtn">Restart</button>
    <button class="btn" id="menuBtn">Menu</button>
  </div>
</div>

<!-- canvas -->
<canvas id="gameCanvas"></canvas>

<script>
/* -----------------------
   CONFIG & PERSISTENCE
   ----------------------- */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let W = canvas.width = window.innerWidth;
let H = canvas.height = window.innerHeight;

// persistent: level, xp, xpGoal, highScore
let level = parseInt(localStorage.getItem('sgqp_level')) || 1;
let xp = parseInt(localStorage.getItem('sgqp_xp')) || 0;
let xpGoal = parseInt(localStorage.getItem('sgqp_xpGoal')) || 100;
let highScore = parseInt(localStorage.getItem('sgqp_high')) || 0;

// game state
let gameStarted=false, gameOver=false, paused=false;
let difficulty = localStorage.getItem('sgqp_diff') || 'normal';

// theme default
let theme = localStorage.getItem('sgqp_theme') || 'darkmetal';

/* -----------------------
   ASSETS: SPRITES GENERATED IN-CODE (dataURL PNG)
   - create offscreen canvases and export to dataURL, then use Image()
   ----------------------- */
function makeSprite(type){
  // simple pixel-art on small offscreen canvas -> return Image object with dataURL
  if(type==='rocket'){
    const s = 64;
    const off = document.createElement('canvas');
    off.width = s; off.height = s;
    const c = off.getContext('2d');
    // transparent bg
    c.clearRect(0,0,s,s);
    // body (pixel-ish)
    c.fillStyle = '#1fb6ff'; c.fillRect(28,8,8,24);
    c.fillStyle = '#0f7fb5'; c.fillRect(26,28,12,8);
    // nose
    c.fillStyle = '#fff'; c.beginPath(); c.moveTo(32,4); c.lineTo(38,12); c.lineTo(26,12); c.closePath(); c.fill();
    // wings
    c.fillStyle = '#ff7f50'; c.fillRect(20,28,8,6);
    c.fillStyle = '#ff7f50'; c.fillRect(36,28,8,6);
    // engine fire
    c.fillStyle = '#ffb84d'; c.fillRect(30,36,4,10);
    c.fillStyle = '#ff4d4d'; c.fillRect(30,46,4,6);
    const img = new Image(); img.src = off.toDataURL('image/png'); return img;
  }
  if(type==='bullet'){
    const s=32; const off=document.createElement('canvas'); off.width=s; off.height=s;
    const c=off.getContext('2d'); c.clearRect(0,0,s,s);
    c.fillStyle='#ffd24d'; c.fillRect(12,4,8,16);
    c.fillStyle='#ffb84d'; c.fillRect(12,20,8,6);
    const img=new Image(); img.src=off.toDataURL('image/png'); return img;
  }
  return null;
}
const rocketImg = makeSprite('rocket');
const bulletImg = makeSprite('bullet');

/* -----------------------
   AUDIO (improved)
   - use short sfx; volume controlled by slider
   ----------------------- */
const SFX = {
  shoot: new Audio('https://cdn.freesound.org/previews/66/66717_931655-lq.mp3'),
  hit:   new Audio('https://cdn.freesound.org/previews/256/256113_4486188-lq.mp3'),
  pickup:new Audio('https://cdn.freesound.org/previews/331/331912_3248244-lq.mp3'),
  damage:new Audio('https://cdn.freesound.org/previews/331/331912_3248244-lq.mp3'),
  levelup:new Audio('https://cdn.freesound.org/previews/461/461418_5121236-lq.mp3') // short chime
};
let masterVolume = parseFloat(localStorage.getItem('sgqp_vol')) || 0.8;
let muted = (localStorage.getItem('sgqp_muted') === '1') || false;
function setVolume(v){
  masterVolume = v;
  localStorage.setItem('sgqp_vol', v);
  for(const k in SFX) SFX[k].volume = muted ? 0 : v;
}
function setMuted(m){
  muted = m;
  localStorage.setItem('sgqp_muted', m ? '1' : '0');
  for(const k in SFX) SFX[k].volume = muted ? 0 : masterVolume;
}
// init volumes
setVolume(masterVolume);

/* -----------------------
   GAME OBJECTS & LIMITS
   ----------------------- */
let difficultyConfig = {
  easy:   { maxEnemies: 7,  enemySpeed: 1.2, spawnMs: 1400 },
  normal: { maxEnemies: 10, enemySpeed: 1.8, spawnMs: 1100 },
  hard:   { maxEnemies: 14, enemySpeed: 2.6, spawnMs: 900 }
};
let cfg = difficultyConfig[difficulty];

const player = {
  x: W/2, y: H-120, w: 64, h: 64, speed: 7,
  lives: 100, maxLives: 100, shield:false
};
const bullets = []; // {x,y,w,h,dy}
const enemies = [];  // {x,y,w,h,hp,color,flash}
const powerUps = []; // {x,y,size,type,pulse}
const particles = []; // explosion particles limited

const MAX_POWERUPS = 3;
const MAX_PARTICLES = 120;

/* -----------------------
   HELPERS
   ----------------------- */
function rand(min,max){return Math.random()*(max-min)+min;}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}

/* -----------------------
   SPAWNERS (respect difficulty cfg)
   ----------------------- */
let enemyInterval = null, powerInterval = null;
function startSpawners(){
  stopSpawners();
  cfg = difficultyConfig[difficulty];
  enemyInterval = setInterval(()=>{
    if(!gameStarted || gameOver || paused) return;
    if(enemies.length < cfg.maxEnemies) spawnEnemy();
  }, cfg.spawnMs);
  powerInterval = setInterval(()=>{
    if(!gameStarted || gameOver || paused) return;
    if(powerUps.length < MAX_POWERUPS) spawnPowerUp();
  }, 13000);
}
function stopSpawners(){ if(enemyInterval) clearInterval(enemyInterval); if(powerInterval) clearInterval(powerInterval); }

/* spawn functions */
function spawnEnemy(){
  const size = 36 + Math.floor(rand(0,38));
  const x = rand(20, W - size - 20);
  const hp = 40 + Math.floor(rand(0,40) * (level*0.1));
  const colors = ['#d14','#f56','#7df','#ff7'];
  enemies.push({ x, y: -size, w:size, h:size, hp, maxHp:hp, color: colors[Math.floor(Math.random()*colors.length)], flash:0 });
}
function spawnPowerUp(){
  const size = 28;
  const x = rand(20, W - size - 20);
  const type = Math.random()<0.6 ? 'life' : 'shield';
  powerUps.push({ x, y:-size, size, type, pulse: Math.random()*6 });
}

/* -----------------------
   Input & Pause handling
   ----------------------- */
const keys = {};
window.addEventListener('keydown', e=>{
  keys[e.key] = true;
  if(gameStarted && (e.key === ' ')) fireBullet();
  if(e.key === 'p' || e.key === 'P') togglePause();
});
window.addEventListener('keyup', e=>{ keys[e.key] = false; });

function togglePause(){
  if(!gameStarted || gameOver) return;
  paused = !paused;
  // improved pause overlay: show menu-like overlay
  const overlay = document.getElementById('pauseOverlay');
  if(paused){
    // create overlay element if absent
    showPause();
  } else hidePause();
}
function showPause(){
  // simple overlay element
  let el = document.getElementById('pauseOverlay');
  if(!el){
    el = document.createElement('div'); el.id='pauseOverlay';
    el.style.position='absolute'; el.style.left='50%'; el.style.top='50%';
    el.style.transform='translate(-50%,-50%)'; el.style.padding='20px'; el.style.borderRadius='12px';
    el.style.background='rgba(6,6,10,0.8)'; el.style.border='1px solid rgba(255,255,255,0.05)';
    el.style.textAlign='center'; el.style.zIndex=9999;
    el.innerHTML=`<h2 style="margin:0 0 10px 0;color:${getAccent()};">PAUZA</h2>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
        <button class="btn primary" id="resumeBtn">WznÃ³w</button>
        <button class="btn" id="toMenuBtn">Menu</button>
      </div>`;
    document.body.appendChild(el);
    document.getElementById('resumeBtn').addEventListener('click', ()=>{ paused=false; hidePause();});
    document.getElementById('toMenuBtn').addEventListener('click', ()=>{ paused=false; hidePause(); document.getElementById('menu').style.display='block'; gameStarted=false; stopSpawners(); });
  } else el.style.display='block';
}
function hidePause(){ const el=document.getElementById('pauseOverlay'); if(el) el.style.display='none'; }

/* -----------------------
   FIRE & SPRITES: use generated PNGs
   ----------------------- */
function fireBullet(){
  // larger bullets now
  const w = 18, h = 36;
  bullets.push({ x: player.x - w/2, y: player.y - player.h/2 - 4, w, h, dy: -14 });
  playSfx('shoot');
}

/* -----------------------
   SOUND helpers
   ----------------------- */
function playSfx(name){
  if(muted) return;
  const s = SFX[name];
  if(!s) return;
  try{ s.currentTime=0; s.volume = masterVolume; s.play(); }catch(e){}
}
function playLevelUp(){
  const s = SFX.levelup;
  if(!muted){ try{ s.currentTime=0; s.volume = masterVolume; s.play(); }catch(e){} }
}

/* -----------------------
   PARTICLES (animated explosions)
   ----------------------- */
function spawnExplosion(x,y,color,count=18){
  for(let i=0;i<count;i++){
    if(particles.length>MAX_PARTICLES) break;
    const angle = Math.random()*Math.PI*2;
    const speed = rand(1.5,6);
    particles.push({
      x, y,
      dx: Math.cos(angle)*speed,
      dy: Math.sin(angle)*speed,
      life: 30 + Math.floor(Math.random()*20),
      size: rand(2,6),
      color
    });
  }
}

/* -----------------------
   UPDATE & DRAW
   ----------------------- */
function update(){
  if(!gameStarted || gameOver || paused) return;

  // update difficulty cfg
  cfg = difficultyConfig ? difficultyConfig[difficulty] : { maxEnemies:10, enemySpeed:2, spawnMs:1100 };

  // player movement
  if(keys['ArrowLeft'] || keys['a']) player.x -= player.speed;
  if(keys['ArrowRight'] || keys['d']) player.x += player.speed;
  if(keys['ArrowUp'] || keys['w']) player.y -= player.speed;
  if(keys['ArrowDown'] || keys['s']) player.y += player.speed;
  player.x = clamp(player.x, player.w/2 + 10, W - player.w/2 - 10);
  player.y = clamp(player.y, player.h/2 + 10, H - player.h/2 - 120);

  // bullets
  for(let i=bullets.length-1;i>=0;i--){
    const b = bullets[i]; b.y += b.dy;
    if(b.y + b.h < 0) bullets.splice(i,1);
  }

  // enemies
  for(let i=enemies.length-1;i>=0;i--){
    const e = enemies[i];
    e.y += cfg.enemySpeed;
    if(e.y > H + 50){ enemies.splice(i,1); continue; }
    // collision with bullets
    for(let j=bullets.length-1;j>=0;j--){
      const b = bullets[j];
      if(b.x < e.x + e.w && b.x + b.w > e.x && b.y < e.y + e.h && b.y + b.h > e.y){
        bullets.splice(j,1);
        e.hp -= 20;
        e.flash = 6;
        playSfx('hit');
        spawnExplosion(e.x + e.w/2, e.y + e.h/2, e.color, 10);
        if(e.hp <= 0){
          // on death
          score += 100;
          xp += 20;
          if(score >= 1000) xp += 30; // one-time extra for hitting thresholds (keeps adding if score>=1000 - OK)
          playSfx('pickup');
          // bigger explosion
          spawnExplosion(e.x + e.w/2, e.y + e.h/2, '#fff', 26);
          enemies.splice(i,1);
          // level-up check
          if(xp >= xpGoal){
            level++;
            xp -= xpGoal;
            xpGoal = Math.floor(xpGoal * 1.5);
            playLevelUp();
            savePersistent();
          }
        }
        break;
      }
    }
    // enemy-player collision
    if(!player.shield && player.x - player.w/2 < e.x + e.w && player.x + player.w/2 > e.x && player.y - player.h/2 < e.y + e.h && player.y + player.h/2 > e.y){
      enemies.splice(i,1);
      player.lives -= 20;
      playSfx('damage');
      spawnExplosion(player.x, player.y, 'red', 14);
      if(player.lives <= 0){
        gameOver = true;
        stopSpawners();
        document.getElementById('gameover').style.display='block';
        // save highscore
        if(score > highScore){ highScore = score; localStorage.setItem('sgqp_high', highScore); }
      }
    }
    if(e.flash > 0) e.flash--;
  }

  // power-ups
  for(let i=powerUps.length-1;i>=0;i--){
    const p = powerUps[i];
    p.y += 1.8;
    p.pulse += 0.06;
    if(player.x - player.w/2 < p.x + p.size && player.x + player.w/2 > p.x && player.y - player.h/2 < p.y + p.size && player.y + player.h/2 > p.y){
      if(p.type === 'life'){ player.lives = Math.min(player.maxLives, player.lives + 20); }
      if(p.type === 'shield'){ player.shield = true; shieldTimer = 600; }
      playSfx('pickup');
      powerUps.splice(i,1);
    }
    if(p.y > H + 50) powerUps.splice(i,1);
  }

  // shield timer
  if(player.shield){
    shieldTimer--;
    if(shieldTimer <= 0) player.shield = false;
  }

  // particles
  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    p.x += p.dx; p.y += p.dy;
    p.dy += 0.12; // gravity-ish
    p.life--;
    if(p.life <= 0) particles.splice(i,1);
  }

  // save XP/level periodically
  savePersistent();
}

function savePersistent(){
  localStorage.setItem('sgqp_level', level);
  localStorage.setItem('sgqp_xp', xp);
  localStorage.setItem('sgqp_xpGoal', xpGoal);
  localStorage.setItem('sgqp_high', highScore);
}

/* -----------------------
   DRAWING: background, HUD (improved), objects, effects
   ----------------------- */
function draw(){
  // clear
  // background gradient based on theme
  drawBackground();

  // draw stars/lines (subtle)
  drawDecor();

  // draw player sprite (use generated rocketImg)
  if(rocketImg.complete){ ctx.drawImage(rocketImg, player.x - player.w/2, player.y - player.h/2, player.w, player.h); } else {
    ctx.fillStyle = player.shield ? '#2af' : '#6cf';
    ctx.fillRect(player.x - player.w/2, player.y - player.h/2, player.w, player.h);
  }

  // bullets (draw using bulletImg)
  bullets.forEach(b => {
    if(bulletImg.complete){
      ctx.drawImage(bulletImg, b.x, b.y, b.w, b.h);
    } else {
      ctx.fillStyle='yellow';
      ctx.fillRect(b.x,b.y,b.w,b.h);
    }
    // trail
    ctx.fillStyle = 'rgba(255,200,60,0.12)';
    ctx.fillRect(b.x - 2, b.y + b.h, b.w + 4, 8);
  });

  // enemies
  enemies.forEach(e => {
    // flash when hit
    if(e.flash > 0){
      ctx.fillStyle = '#fff';
      ctx.fillRect(e.x-2, e.y-2, e.w+4, e.h+4);
    }
    ctx.fillStyle = e.color; ctx.fillRect(e.x, e.y, e.w, e.h);
    // smooth hp bar above enemy
    ctx.fillStyle = '#222'; ctx.fillRect(e.x, e.y - 8, e.w, 5);
    ctx.fillStyle = '#0f0'; ctx.fillRect(e.x, e.y - 8, (e.hp / e.maxHp) * e.w, 5);
  });

  // power-ups (pulsing)
  powerUps.forEach(p => {
    ctx.save();
    const pulse = 1 + Math.sin(p.pulse) * 0.12;
    ctx.translate(p.x + p.size/2, p.y + p.size/2);
    ctx.scale(pulse, pulse);
    ctx.fillStyle = p.type === 'life' ? '#6f6' : '#5cf';
    ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
    ctx.restore();
  });

  // particles (explosions)
  particles.forEach(p => {
    ctx.fillStyle = p.color;
    ctx.globalAlpha = Math.max(0, p.life / 40);
    ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1;
  });

  // improved HUD drawn on canvas bottom-left / top-right separate DOM already shows some info
  drawHUDCanvas();
}

/* draw background by theme */
function drawBackground(){
  // base gradient
  if(theme === 'darkmetal'){
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'#051018'); g.addColorStop(1,'#00080a');
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
  } else if(theme === 'cyberchrome'){
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'#0b0f12'); g.addColorStop(1,'#061018');
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
  } else { // blueneon
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'#021428'); g.addColorStop(1,'#000a12');
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
  }
}

/* decorative small moving lines */
let decorTick = 0;
function drawDecor(){
  decorTick += 1;
  // subtle horizontal lines
  ctx.strokeStyle = 'rgba(255,255,255,0.02)';
  ctx.lineWidth = 1;
  for(let i=0;i<6;i++){
    const y = ((i*150) + (decorTick*0.2)) % (H + 100) - 50;
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y+20); ctx.stroke();
  }
  // stars (simple)
  ctx.fillStyle = 'rgba(255,255,255,0.06)';
  for(let i=0;i<20;i++){
    const x = (i*83 + decorTick*0.5) % W;
    const y = (i*47 + decorTick*0.8) % H;
    ctx.fillRect(x, y, 1.5,1.5);
  }
}

/* HUD drawing on canvas bottom-left: fancy bars */
function drawHUDCanvas(){
  // update DOM top-right values
  document.getElementById('hudScore').innerText = `Punkty: ${score}`;
  document.getElementById('hudLevel').innerText = `Poziom: ${level}`;
  document.getElementById('hudHigh').innerText = `High Score: ${highScore}`;

  // bottom-left bars
  const left = 20; const hpY = H - 60;
  const barW = 320;
  // HP background
  ctx.fillStyle = 'rgba(255,255,255,0.05)'; ctx.fillRect(left-4, hpY-4, barW+8, 36);
  // HP label
  ctx.font = '14px Arial'; ctx.fillStyle = '#cfe7ff'; ctx.fillText('HP', left, hpY - 10);
  // HP gradient
  const hpGrad = ctx.createLinearGradient(left, hpY, left+barW, hpY+26);
  hpGrad.addColorStop(0, '#ff4040'); hpGrad.addColorStop(0.5, '#ffb040'); hpGrad.addColorStop(1, '#4fff7d');
  ctx.fillStyle = '#2b2b2b'; ctx.fillRect(left, hpY, barW, 26);
  ctx.fillStyle = hpGrad; ctx.fillRect(left, hpY, (player.lives/player.maxLives) * barW, 26);
  ctx.strokeStyle = 'rgba(255,255,255,0.12)'; ctx.strokeRect(left, hpY, barW, 26);

  // XP bar below
  const xpY = hpY + 34;
  ctx.font='14px Arial'; ctx.fillStyle='#cfe7ff'; ctx.fillText('XP', left, xpY - 8);
  ctx.fillStyle='#2b2b2b'; ctx.fillRect(left, xpY, barW, 16);
  ctx.fillStyle='#4da6ff'; ctx.fillRect(left, xpY, clamp(xp/xpGoal,0,1) * barW, 16);
  ctx.strokeStyle = 'rgba(255,255,255,0.08)'; ctx.strokeRect(left, xpY, barW, 16);

  // small text for xp numbers
  ctx.font='12px Arial'; ctx.fillStyle='#bfe9ff';
  ctx.fillText(`${xp} / ${xpGoal} XP`, left + barW + 10, xpY + 12);

  // show difficulty small
  ctx.font='12px Arial'; ctx.fillStyle='#d6ffd6';
  ctx.fillText(`Difficult: ${difficulty}`, W - 160, H - 20);
}

/* -----------------------
   Resize handler
   ----------------------- */
window.addEventListener('resize', ()=>{
  W = canvas.width = window.innerWidth;
  H = canvas.height = window.innerHeight;
});

/* -----------------------
   MAIN LOOP
   ----------------------- */
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();

/* -----------------------
   UI hooks & settings
   ----------------------- */
document.getElementById('settingsBtn').addEventListener('click', ()=>{
  const p = document.getElementById('settingsPanel');
  p.style.display = (p.style.display === 'block') ? 'none' : 'block';
});
document.getElementById('themeSelect').value = theme;
document.getElementById('themeSelect').addEventListener('change', e=>{
  theme = e.target.value; localStorage.setItem('sgqp_theme', theme);
  // change accent colors quickly
  if(theme==='darkmetal'){ document.documentElement.style.setProperty('--bg1','#071018'); document.documentElement.style.setProperty('--accent','#6cf'); }
  if(theme==='cyberchrome'){ document.documentElement.style.setProperty('--bg1','#081018'); document.documentElement.style.setProperty('--accent','#9ff'); }
  if(theme==='blueneon'){ document.documentElement.style.setProperty('--bg1','#021428'); document.documentElement.style.setProperty('--accent','#7df'); }
});
document.getElementById('difficultySelect').value = difficulty;
document.getElementById('difficultySelect').addEventListener('change', e=>{
  difficulty = e.target.value; localStorage.setItem('sgqp_diff', difficulty);
  cfg = difficultyConfig[difficulty];
  startSpawners();
});
document.getElementById('volume').value = masterVolume;
document.getElementById('volume').addEventListener('input', e=>{
  setVolume(parseFloat(e.target.value));
});
document.getElementById('muteBtn').addEventListener('click', ()=>{
  setMuted(!muted);
  document.getElementById('muteBtn').innerText = muted ? 'ðŸ”ˆ' : 'ðŸ”‡';
});
document.getElementById('resetProgressBtn').addEventListener('click', ()=>{
  if(confirm('ZresetowaÄ‡ poziom i XP?')){ level=1; xp=0; xpGoal=100; localStorage.removeItem('sgqp_level'); localStorage.removeItem('sgqp_xp'); localStorage.removeItem('sgqp_xpGoal'); }
});

/* start/restart/menu buttons */
document.getElementById('startBtn').addEventListener('click', ()=>{
  document.getElementById('menu').style.display = 'none';
  gameStarted = true; gameOver=false;
  resetGame(false); startSpawners();
});
document.getElementById('startBtn2').addEventListener('click', ()=>{ document.getElementById('menu').style.display = 'none'; gameStarted = true; resetGame(false); startSpawners(); });
document.getElementById('restartBtn').addEventListener('click', ()=>{ document.getElementById('gameover').style.display='none'; resetGame(false); gameStarted=true; startSpawners(); });
document.getElementById('menuBtn').addEventListener('click', ()=>{ document.getElementById('gameover').style.display='none'; document.getElementById('menu').style.display='block'; gameStarted=false; stopSpawners(); });

/* -----------------------
   Start: init volumes, start spawners if desired
   ----------------------- */
document.getElementById('hudTitle').innerText = 'Shooting Game Q Pro';
document.getElementById('hudScore').innerText = `Punkty: ${score}`;
document.getElementById('hudLevel').innerText = `Poziom: ${level}`;
document.getElementById('hudHigh').innerText = `High Score: ${highScore}`;

/* expose some debug helpers for your convenience (optional) */
window.SGQP = { setLevel:(n)=>{level=n; savePersistent();}, addXP:(n)=>{xp+=n;}, getState:()=>({level,xp,xpGoal,highScore}) };

</script>
</body>
</html>
